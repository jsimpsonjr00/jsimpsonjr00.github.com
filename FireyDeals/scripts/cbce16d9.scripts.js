"use strict";angular.module("jsMaxlength",[]).directive("jsMaxlength",function(){return{require:"ngModel",link:function(a,b,c,d){function e(a){if(a.length>f){var b=a.substring(0,f);return d.$setViewValue(b),d.$render(),b}return a}var f=Number(c.jsMaxlength);a[c.ngModel.split(".")[0]].jsMaxLength=f,d.$parsers.push(e)}}}).directive("jsInputCounter",function(){return{restrict:"E",scope:{text:"@"},replace:!0,template:"<span>{{ text.length }} / {{ jsMaxlength }}</span>",link:function(a,b,c){var d=$(c.input);a.jsMaxlength=d.length>0?d.attr("js-maxlength"):""}}});var fireyApp=angular.module("FireyApp",["firebase","jsMaxlength","ngSanitize"]);fireyApp.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/guest.html",controller:["$scope","angularFire","angularFireAuth","$location",function(a,b,c,d){a.$on("angularFireAuth:login",function(){d.path("/member")})}]}).when("/about",{templateUrl:"views/about/about.html"}).when("/how-it-works",{templateUrl:"views/about/how-it-works.html"}).when("/member",{templateUrl:"views/member.html",authRequired:!0,controller:["$scope","angularFire","angularFireAuth","$location",function(a,b,c,d){a.$on("angularFireAuth:logout",function(){d.path("/")})}]}).otherwise({redirectTo:"/"})}]),fireyApp.filter("toArray",function(){return function(a){return a instanceof Object?Object.keys(a).map(function(b){return Object.defineProperty(a[b],"$key",{__proto__:null,value:b})}):a}}),fireyApp.filter("jsBeforeNow",function(){return function(a){return(new Date).valueOf()-a}}).filter("jsSinceTime",function(){return function(a){var b={offset:6e4*(new Date).getTimezoneOffset(),second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5},c=new Date,d="",e=c-a;return d=isNaN(e)||0>e?"":e<2*b.second?"right now":e<b.minute?Math.floor(e/b.second)+" seconds ago":e<2*b.minute?"1 minute ago":e<b.hour?Math.floor(e/b.minute)+" minutes ago":e<2*b.hour?"1 hour ago":e<b.day?Math.floor(e/b.hour)+" hours ago":e>b.day&&e<2*b.day?"yesterday":e<365*b.day?Math.floor(e/b.day)+" days ago":"over a year ago"}}),fireyApp.constant("threshold",{dead:3,hated:-5,firey:5,aging:2592e5}),fireyApp.controller("Dealio",["$scope","angularFire","angularFireAuth","$filter","threshold","$location","$sanitize",function(a,b,c,d,e,f,g){var h="https://dealio.firebaseio.com/",i=new Firebase(h+"deals");a.threshold=e,a.brand="Firey Deals",a.ref=i,a.$on("$routeChangeStart",function(b,c){!c.$$route.authRequired||a.user&&void 0!==a.user.firebaseAuthToken||(b.preventDefault(),f.path("/"))}),a.sort={reverse:!0,field:"timestamp"},a.filter={collection:"firey"},a.navToRoot=function(){a.user&&a.user.firebaseAuthToken?f.path("/member"):f.path("/")},a.$watch("filter.collection + sort.field + sort.reverse",a.navToRoot);var j={title:"",url:"",detail:"",codes:{},likes:{},dislikes:{},score:1,owner:{id:1,name:""},timestamp:0,flags:{}};a.newDeal=angular.extend({},j),a.deals={fresh:{},dead:{},hated:{},ids:{maxID:"a",recycle:[]}},c.initialize(i,{scope:a,name:"user"}),a.registering=!1,a.register=function(){var b=new Firebase(h+"users/aliases/"+a.user.alias);a.user.email=g(a.user.email),a.user.password=g(a.user.password),a.user.alias=g(a.user.alias),b.once("value",function(b){null!==b.val()?a.authError.alias=!0:c.createUser(a.user.email,a.user.password,function(b,c){b||(new Firebase(h+"users/extInfo/"+c.id).set({alias:a.user.alias}),new Firebase(h+"users/aliases/"+a.user.alias).set(c.id))})})},a.toggleRegister=function(){a.registering=!a.registering};var k={error:"",email:!1,pwd:!1,alias:!1};a.authError=angular.extend({},k),a.login=function(){a.user.email=g(a.user.email),a.user.password=g(a.user.password),c.login("password",a.user)},a.$on("angularFireAuth:login",function(b,c){a.authError=angular.extend({},k);var d=new Firebase(h+"users/extInfo/"+c.id);d.once("value",function(b){a.user.alias=b.val().alias,a.$digest()})}),a.logout=function(){c.logout()},a.$on("angularFireAuth:error",function(b,c){switch(a.authError.error=c.code,c.code){case"INVALID_PASSWORD":a.authError.pwd=!0,a.authError.email=!1;break;default:a.authError.email=!0,a.authError.pwd=!1}}),a.startIndex=0,a.inPage=function(a){return a>0},a.orderToggle=function(){a.sort.reverse=!a.sort.reverse},b(i,a,"deals").then(function(){function b(){var b=a.deals.ids.maxID,c=a.deals.ids.recycle;return c&&c.length>0?(b=c[0],c.shift()):a.deals.ids.maxID=i.encode(i.decode(b)+1),b}function c(a){a.title=g(a.title),a.detail=g(a.detail),a.url=g(a.url)}function d(b,c){a.filter.collection!==c&&(a.deals[c]?null:a.deals[c]={},a.deals[c][b.id]=b,delete a.deals[a.filter.collection][b.id],a.alert={status:c})}function f(a){a.score>=e.firey?d(a,"firey"):a.score>e.hated&&a.score<e.firey?d(a,"fresh"):a.score<=e.hated&&d(a,"hated")}function h(b){a.deals.ids.recycle?a.deals.ids.push(b):a.deals.ids.recycle=[b]}var i=function(a){return a.chars=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],a.encode=function(a){if(0===a)return"0";for(var b="";a>0;)b=this.chars[a%62]+b,a=Math.floor(a/62);return b},a.decode=function(a,b,c,d){for(b=c=(a===(/\W|_|^$/.test(a+="")||a))-1;d=a.charCodeAt(c++);)b=62*b+d-[,48,29,87][d>>5];return b},a}({});a.addDeal=function(){c(a.newDeal),a.newDeal.id=b(),a.newDeal.owner={id:a.user.id,alias:a.user.alias},a.newDeal.timestamp=(new Date).valueOf(),a.newDeal.likes[a.user.id]=!0,a.deals.fresh?null:a.deals.fresh={},a.deals.fresh[a.newDeal.id]=a.newDeal,a.newDeal=angular.extend({},j)},a.edit=function(){},a.flag=function(b,c){b.flags?null:b.flags={},b.flags[c]?b.flags[c][a.user.id]?(b.flags[c].count--,delete b.flags[c][a.user.id]):(b.flags[c].count++,b.flags[c][a.user.id]=!0):(b.flags[c]={count:1},b.flags[c][a.user.id]=!0),a.flagOpps[c]?a.flagOpps[c](b):null},a.flagOpps={dead:function(a){a.flags.dead.count>=e.dead&&d(a,"dead")}},a.like=function(b){var c=a.user.id;b.likes?null:b.likes={},b.likes[c]?(b.score--,delete b.likes[c]):(b.likes[c]=!0,b.score++,b.dislikes&&b.dislikes[c]&&(b.score++,delete b.dislikes[c])),f(b)},a.dislike=function(b){var c=a.user.id;b.dislikes?null:b.dislikes={},b.dislikes[c]?(b.score++,delete b.dislikes[c]):(b.dislikes[c]=!0,b.score--,b.likes&&b.likes[c]&&(b.score--,delete b.likes[c])),f(b)},a.ageDeals=function(){var b=a.deals.fresh;for(var c in b)(new Date).valueOf()-b[c].timestamp>a.threshold.aging&&d(b[c],"aging")},a.deleteDeal=function(b){a.deletingDeal=b;var c=$("#confirm-delete-modal").modal();c.attr("data-index",b.id),c.on("click",".btn-danger",function(){var b=c.attr("data-index");delete a.deals[a.filter.collection][b],c.modal("hide"),h(b),a.$digest()})},a.editDeal=function(b){a.editingDeal=angular.extend({},b);var c=$("#edit-deal-modal").modal();c.on("click",".btn-danger",function(){a.deals[a.filter.collection][a.editingDeal.id]=a.editingDeal,c.modal("hide"),a.$digest()})},a.resurectDeal=function(b){"dead"==a.filter.collection&&(delete b.flags.dead,f(b))}})}]);